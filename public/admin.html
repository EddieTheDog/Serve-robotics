<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #fff; padding: 30px; }
  h1 { text-align: center; margin-bottom: 30px; }
  .guest { border: 1px solid #ccc; padding: 16px; margin-bottom: 20px; border-radius: 8px; }
  .guest h3 { margin: 0 0 12px 0; text-align: center; }
  .guest-row { display: flex; align-items: flex-start; gap: 20px; }
  .qr-box {
    width: 120px;
    height: 120px;
    border: 2px dashed #999;
    border-radius: 8px;
    display: inline-block;
    background-color: #fff;
    text-align: center;
  }
  .qr-box canvas {
    width: 100%;
    height: 100%;
    display: block;
    margin: 0 auto;
  }
  .buttons { display: flex; flex-direction: column; gap: 8px; }
  button { padding: 10px; font-size: 16px; cursor: pointer; }
  .qr-text { margin-top: 12px; font-size: 12px; word-break: break-all; text-align: center; color: #333; }
</style>
</head>
<body>

<h1>Admin Dashboard</h1>
<div id="queue"></div>

<script>
async function loadQueue() {
  const res = await fetch("/api/queue");
  const guests = await res.json();
  const q = document.getElementById("queue");
  q.innerHTML = "";

  guests.forEach(g => {
    const div = document.createElement("div");
    div.className = "guest";

    div.innerHTML = `
      <h3>${g.first_name} ${g.last_name}</h3>
      <div class="guest-row">
        <div class="qr-box" id="qr-${g.id}"></div>
        <div class="buttons">
          <button onclick="setStatus('${g.id}','accepted')">Accept</button>
          <button onclick="setStatus('${g.id}','declined')">Decline</button>
          <button onclick="setStatus('${g.id}','help')">Help</button>
          <button onclick="nextGuest('${g.id}')">Next Guest</button>
        </div>
      </div>
      <div class="qr-text" id="qrtext-${g.id}"></div>
    `;
    q.appendChild(div);

    // Only render QR if qr_data exists
    if (g.qr_data) {
      const qrBox = document.getElementById(`qr-${g.id}`);

      // Clear any previous QR content
      qrBox.innerHTML = "";

      // Create a canvas for QRious
      const canvas = document.createElement("canvas");
      qrBox.appendChild(canvas);

      // Prepend https:// only for QR generation
      let qrValue = g.qr_data.trim();
      if (!qrValue.startsWith("http://") && !qrValue.startsWith("https://")) {
        qrValue = "https://" + qrValue;
      }

      try {
        new QRious({
          element: canvas,
          value: qrValue,
          size: 120
        });
      } catch (err) {
        console.error("QR code generation failed:", err);
      }

      // Show original text below QR and buttons
      document.getElementById(`qrtext-${g.id}`).innerText = g.qr_data;
    }
  });
}

async function setStatus(id, status) {
  await fetch("/api/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ guestId: id, status })
  });
  loadQueue();
}

async function nextGuest(id) {
  await fetch("/api/next", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ guestId: id })
  });
  loadQueue();
}

// Initial load + refresh every 3 seconds
loadQueue();
setInterval(loadQueue, 3000);
</script>

</body>
</html>
