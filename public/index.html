<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>The Eddie's 2025 - Self Checkin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<style>
* { box-sizing:border-box; margin:0; padding:0; user-select:none; touch-action: manipulation; }
body { font-family:'Helvetica Neue', Helvetica, Arial, sans-serif; margin:0; padding:0; height:100vh; width:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#fff; color:#333; }
#main-container { width:100%; max-width:600px; padding:20px; text-align:center; flex:1; position:relative; }
h1 { margin-bottom:20px; font-size:32px; text-transform:uppercase; font-weight:800; letter-spacing:2px; }

/* Fake input styles */
.fake-input {
  font-size:24px; padding:15px; margin-bottom:15px; width:100%;
  border-radius:8px; border:2px solid #e0e0e0; background:#f8f8f8;
  text-align:left; height:48px; display:flex; align-items:center; position:relative; cursor:text;
  overflow-x:auto; white-space:nowrap; color:#333;
}
.fake-input.active { border-color:#000; }
.fake-input .cursor { width:2px; background:#000; animation:blink 1s step-start infinite; margin-left:2px; height:1em; }
@keyframes blink { 0%,50%,100%{opacity:1;} 25%,75%{opacity:0;} }
.fake-input[data-placeholder]::before { content: attr(data-placeholder); color:#aaa; pointer-events:none; }
.fake-input.has-content::before { display:none; }

button { display:block; font-size:18px; padding:18px; margin-top:10px; width:100%; background:#000; color:#fff; border:none; border-radius:8px; cursor:pointer; text-transform:uppercase; font-weight:700; letter-spacing:1px; }
button:active { opacity:0.8; }

#form-step-2, #waiting { display:none; }
#camera-container { width:100%; max-width:300px; height:300px; margin:0 auto 20px; border:4px solid #000; border-radius:12px; overflow:hidden; background:#000; position:relative; }
#video { width:100%; height:100%; object-fit:cover; }
#camera-msg { position:absolute; bottom:10px; left:0; right:0; color:white; background:rgba(0,0,0,0.7); padding:5px; font-size:14px; }

#dots { display:none; justify-content:center; gap:15px; margin-top:30px; }
#dots button { width:50px; height:50px; font-size:12px; border-radius:50%; background:#f0f0f0; color:#ccc; display:flex; align-items:center; justify-content:center; margin:0; }

#custom-keyboard { display:flex; flex-direction:column; position:fixed; bottom:0; left:0; right:0; background:#000; padding:5px; gap:5px; z-index:1000; }
.keyboard-row { display:flex; justify-content:center; gap:5px; }
.keyboard-row button { flex:1; font-size:22px; padding:15px 0; border-radius:12px; border:2px solid #000; background:#111; color:#fff; font-weight:700; cursor:pointer; transition:transform 0.1s, background 0.2s; }
.keyboard-row button:active { transform:scale(0.95); background:#333; }

#fullscreen-btn { position:absolute; top:20px; right:20px; width:40px; height:40px; background:#000; color:#fff; border-radius:6px; display:flex; justify-content:center; align-items:center; font-weight:bold; cursor:pointer; z-index:2000; }
</style>
</head>
<body>
<div id="main-container">
  <h1>The Eddie's 2025 - Self Checkin</h1>

  <div id="form-step-1">
    <div id="first" class="fake-input" data-placeholder="First Name"></div>
    <div id="last" class="fake-input" data-placeholder="Last Name"></div>
    <button id="next-btn">Next</button>
    <div id="custom-keyboard"></div>
    <div id="fullscreen-btn">C</div>
  </div>

  <div id="form-step-2">
    <div id="camera-container">
      <video id="video" playsinline></video>
      <div id="camera-msg">Scan your QR code</div>
    </div>
  </div>

  <div id="waiting">
    <h2 id="message">Please wait...</h2>
    <div id="dots">
      <button onclick="dotClick(0)">●</button>
      <button onclick="dotClick(1)">●</button>
      <button onclick="dotClick(2)">●</button>
    </div>
  </div>
</div>

<script>
let guestId=null, pollTimer=null, dotStep=0, declineActive=false, scannedData="";
let activeBox=null;
const boxes=[document.getElementById("first"), document.getElementById("last")];
const keyboard=document.getElementById("custom-keyboard"), fsBtn=document.getElementById("fullscreen-btn");
const nextBtn=document.getElementById("next-btn");

const keyboardRows = [
  ["q","w","e","r","t","y","u","i","o","p"],
  ["a","s","d","f","g","h","j","k","l"],
  ["z","x","c","v","b","n","m","DEL"," "]
];

// --- Fake input helpers ---
function setActiveBox(box){
  boxes.forEach(b=> { let cursor=b.querySelector(".cursor"); if(cursor) cursor.remove(); b.classList.remove("active"); });
  activeBox=box;
  activeBox.classList.add("active");
  const cursor=document.createElement("div"); cursor.className="cursor";
  activeBox.appendChild(cursor);
  showKeyboard(activeBox);
}

// Show keyboard
function showKeyboard(box){
  keyboard.innerHTML="";
  keyboardRows.forEach(row=>{
    const div=document.createElement("div"); div.className="keyboard-row";
    row.forEach(key=>{
      const btn=document.createElement("button");
      btn.textContent=key===" "?"␣":key.toUpperCase()==="DEL"?"DEL":key;
      btn.onclick=()=>insertKey(key);
      div.appendChild(btn);
    });
    keyboard.appendChild(div);
  });
  keyboard.style.display="flex";
}

// Insert key
function insertKey(key){
  if(!activeBox) return;
  let content=activeBox.textContent.replace(/\u200B/g,'');
  if(key==="DEL") content=content.slice(0,-1);
  else if(key===" ") content+=" ";
  else content+=key;
  activeBox.textContent=content;

  // Update cursor
  let cursor=activeBox.querySelector(".cursor");
  if(cursor) cursor.remove();
  const newCursor=document.createElement("div"); 
  newCursor.className="cursor";
  activeBox.appendChild(newCursor);

  // Update placeholder
  if(content.length>0) activeBox.classList.add("has-content");
  else activeBox.classList.remove("has-content");
}

boxes.forEach(box=> box.addEventListener("click",()=>setActiveBox(box)));

// Fullscreen
fsBtn.addEventListener("click",()=>{ 
  const elBody=document.documentElement; 
  if(elBody.requestFullscreen) elBody.requestFullscreen(); 
  else if(elBody.webkitRequestFullscreen) elBody.webkitRequestFullscreen(); 
  else if(elBody.msRequestFullscreen) elBody.msRequestFullscreen();
});
document.addEventListener("fullscreenchange",()=>{ fsBtn.style.display=(document.fullscreenElement)?'none':'flex'; });
document.addEventListener("webkitfullscreenchange",()=>{ fsBtn.style.display=(document.webkitFullscreenElement)?'none':'flex'; });
document.addEventListener("msfullscreenchange",()=>{ fsBtn.style.display=(document.msFullscreenElement)?'none':'flex'; });

// Long press Next for fullscreen
let nextPressTimer=null;
nextBtn.addEventListener("mousedown", ()=>{ nextPressTimer=setTimeout(()=>fsBtn.click(),1000); });
nextBtn.addEventListener("mouseup", ()=>clearTimeout(nextPressTimer));
nextBtn.addEventListener("mouseleave", ()=>clearTimeout(nextPressTimer));
nextBtn.addEventListener("click", goToScan);

// Focus first box
window.onload=()=>setActiveBox(boxes[0]);

// Disable hardware keyboard
document.addEventListener("keydown", e=>e.preventDefault());
document.addEventListener("keypress", e=>e.preventDefault());
document.addEventListener("input", e=>e.preventDefault());

// --- QR Scan ---
function goToScan(){
  if(!boxes[0].textContent.trim() || !boxes[1].textContent.trim()) return alert("Please enter both names");
  document.getElementById("form-step-1").style.display="none";
  document.getElementById("form-step-2").style.display="block";
  keyboard.style.display="none";
  startScanner();
}

function startScanner(){
  const video=document.getElementById("video"), cameraMsg=document.getElementById("camera-msg");
  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
    .then(stream=>{ video.srcObject=stream; video.play(); requestAnimationFrame(tick); })
    .catch(err=>{ cameraMsg.innerText="Camera access denied."; console.error(err); });
  function tick(){
    if(video.readyState===video.HAVE_ENOUGH_DATA){
      const canvas=document.createElement("canvas").getContext("2d");
      canvas.canvas.width=video.videoWidth; canvas.canvas.height=video.videoHeight;
      canvas.drawImage(video,0,0,canvas.canvas.width,canvas.canvas.height);
      const imageData=canvas.getImageData(0,0,canvas.canvas.width,canvas.canvas.height);
      const code=jsQR(imageData.data,imageData.width,imageData.height);
      if(code){ scannedData=code.data; cameraMsg.innerText="QR Scanned!"; cameraMsg.style.background="green"; video.srcObject.getTracks().forEach(t=>t.stop()); submitCheckin(); return; }
    }
    requestAnimationFrame(tick);
  }
}

// --- Submit ---
async function submitCheckin(){
  const res=await fetch("/api/checkin",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({firstName:boxes[0].textContent,lastName:boxes[1].textContent,qrData:scannedData})});
  const data=await res.json(); guestId=data.guestId;
  document.getElementById("form-step-2").style.display="none";
  document.getElementById("waiting").style.display="block";
  document.getElementById("message").innerText="Thank you. Please wait a minute while we analyze your information.";
  dotStep=0; document.getElementById("dots").style.display="none"; declineActive=false;
  pollTimer=setInterval(pollStatus,2000);
}

// --- Poll ---
async function pollStatus(){
  if(!guestId) return;
  const res=await fetch(`/api/guest/${guestId}`); const g=await res.json();
  switch(g.status){
    case "accepted": document.getElementById("message").innerText=`${g.first_name}, your name tag is on the way.`; document.getElementById("dots").style.display="none"; declineActive=false; break;
    case "declined": document.getElementById("message").innerText="Please wait one additional minute."; document.getElementById("dots").style.display="flex"; declineActive=true; dotStep=0; break;
    case "completed": case "dismissed": resetKiosk(); break;
  }
}

// --- Dot click ---
function dotClick(index){ if(!declineActive) return; const sequence=[1,0,2]; if(index===sequence[dotStep]){dotStep++; if(dotStep===3) awaitDismiss();} else dotStep=0; }
function awaitDismiss(){ fetch("/api/update",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({guestId,status:"dismissed"})}).then(()=>resetKiosk()); }

// --- Reset kiosk ---
function resetKiosk(){
  clearInterval(pollTimer); pollTimer=null; guestId=null; scannedData=""; declineActive=false; dotStep=0;
  boxes.forEach(box=>{ box.textContent=""; box.classList.remove("has-content"); });
  document.getElementById("waiting").style.display="none";
  document.getElementById("form-step-1").style.display="block";
  document.getElementById("form-step-2").style.display="none";
  document.getElementById("dots").style.display="none";
  document.getElementById("camera-msg").style.background="rgba(0,0,0,0.7)";
  document.getElementById("camera-msg").innerText="Scan your QR code";
  setActiveBox(boxes[0]);
}
</script>
</body>
</html>
