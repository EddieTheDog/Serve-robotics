<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>The Eddie's 2025 - Self Checkin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<style>
  * { box-sizing: border-box; }
  html, body { height: 100%; margin:0; padding:0; font-family:'Helvetica Neue', Helvetica, Arial, sans-serif; }
  body { display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fff; color: #333; }
  #main-container { width: 100%; max-width: 600px; padding: 20px; text-align: center; transition: all 0.3s ease; }
  h1 { margin: 0 0 30px 0; font-size: 32px; font-weight:800; text-transform:uppercase; letter-spacing:2px; color:#000; }
  input { display:block; font-size:18px; padding:15px; margin-bottom:15px; width:100%; border:2px solid #e0e0e0; border-radius:8px; background:#f8f8f8; text-align:center; outline:none; color:#333; }
  input:focus { border-color:#000; background:#fff; }
  button { display:block; font-size:18px; padding:18px; width:100%; background:#000; color:#fff; border:none; border-radius:8px; text-transform:uppercase; font-weight:700; letter-spacing:1px; cursor:pointer; }
  button:active { opacity:0.8; }
  #form-step-1, #form-step-2 { display:none; }
  #camera-container { width:100%; max-width:300px; height:300px; margin:0 auto 20px auto; border:4px solid #000; border-radius:12px; overflow:hidden; position:relative; background:#000; }
  #video { width:100%; height:100%; object-fit:cover; }
  #camera-msg { position:absolute; bottom:10px; left:0; right:0; color:white; background:rgba(0,0,0,0.7); padding:5px; font-size:14px; }
  #waiting { display:none; }
  #dots { display:none; justify-content:center; gap:15px; margin-top:30px; }
  #dots button { width:50px; height:50px; font-size:12px; border-radius:50%; background:#f0f0f0; color:#ccc; display:flex; align-items:center; justify-content:center; margin:0; }
</style>
</head>
<body>
<div id="main-container">
  <h1>The Eddie's 2025 - Self Checkin</h1>

  <div id="form-step-1">
    <input id="first" placeholder="First Name" />
    <input id="last" placeholder="Last Name" />
    <button id="next-btn">Next</button>
  </div>

  <div id="form-step-2">
    <div id="camera-container">
      <video id="video" playsinline></video>
      <div id="camera-msg">Scan your QR code</div>
    </div>
  </div>

  <div id="waiting">
    <h2 id="message">Please wait...</h2>
    <div id="dots">
      <button onclick="dotClick(0)">●</button>
      <button onclick="dotClick(1)">●</button>
      <button onclick="dotClick(2)">●</button>
    </div>
  </div>
</div>

<script>
let guestId = null, pollTimer = null, dotStep = 0, declineActive = false, scannedData = "", typingTimer = null;
const nextButton = document.getElementById("next-btn");

// Utility
function el(id) { return document.getElementById(id); }

// Device detection
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const isMobile = /Mobi|Android/i.test(navigator.userAgent);

// Auto-focus & hands-free typing
function setupAutoFocus() {
  const firstInput = el("first");
  const lastInput = el("last");

  firstInput.focus();

  firstInput.addEventListener("input", () => debounceMove(lastInput));
  lastInput.addEventListener("input", () => debounceMove(nextButton, true));
}

// Debounce typing
function debounceMove(nextElem, click=false) {
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => {
    if (click) nextElem.click();
    else nextElem.focus();
  }, 3000);
}

// Long press fullscreen detection
let pressTimer = null;
nextButton.addEventListener("mousedown", () => { pressTimer = setTimeout(enterFullscreen, 1000); });
nextButton.addEventListener("mouseup", () => clearTimeout(pressTimer));
nextButton.addEventListener("mouseleave", () => clearTimeout(pressTimer));

function enterFullscreen() {
  const docEl = document.documentElement;
  if (docEl.requestFullscreen) docEl.requestFullscreen();
  else if (docEl.webkitRequestFullscreen) docEl.webkitRequestFullscreen();
  else if (docEl.msRequestFullscreen) docEl.msRequestFullscreen();
}

// Exit fullscreen automatically
function exitFullscreen() {
  if (document.fullscreenElement) document.exitFullscreen();
  else if (document.webkitFullscreenElement) document.webkitExitFullscreen();
  else if (document.msFullscreenElement) document.msExitFullscreen();
}

// Handle keyboard visibility (iPad/IOS)
function handleKeyboard() {
  if (!isIOS) return;
  window.addEventListener('focusin', e => {
    el("main-container").style.transform = 'translateY(-100px)';
  });
  window.addEventListener('focusout', e => {
    el("main-container").style.transform = 'translateY(0)';
  });
}

// Navigation
async function goToScan() {
  const first = el("first").value.trim();
  const last = el("last").value.trim();
  if (!first || !last) return alert("Please enter both names");

  el("form-step-1").style.display = "none";
  el("form-step-2").style.display = "block";
  startScanner();
}

// QR scanner
function startScanner() {
  const video = el("video");
  const cameraMsg = el("camera-msg");

  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => { video.srcObject = stream; video.play(); requestAnimationFrame(tick); })
    .catch(err => { cameraMsg.innerText = "Camera access denied."; console.error(err); });

  function tick() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      const canvas = document.createElement("canvas").getContext("2d");
      canvas.canvas.width = video.videoWidth;
      canvas.canvas.height = video.videoHeight;
      canvas.drawImage(video, 0, 0, canvas.canvas.width, canvas.canvas.height);
      const imageData = canvas.getImageData(0, 0, canvas.canvas.width, canvas.canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      if (code) {
        scannedData = code.data;
        cameraMsg.innerText = "QR Scanned!";
        cameraMsg.style.background = "green";
        video.srcObject.getTracks().forEach(track => track.stop());
        submitCheckin();
        return;
      }
    }
    requestAnimationFrame(tick);
  }
}

// Submit check-in
async function submitCheckin() {
  const first = el("first").value.trim();
  const last = el("last").value.trim();
  const res = await fetch("/api/checkin", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ firstName: first, lastName: last, qrData: scannedData })
  });
  const data = await res.json();
  guestId = data.guestId;

  el("form-step-2").style.display = "none";
  el("waiting").style.display = "block";
  el("message").innerText = "Thank you. Please wait a minute while we analyze your information.";
  dotStep = 0; el("dots").style.display = "none"; declineActive = false;
  pollTimer = setInterval(pollStatus, 2000);
}

// Polling status
async function pollStatus() {
  if (!guestId) return;
  const res = await fetch(`/api/guest/${guestId}`);
  const g = await res.json();

  switch(g.status) {
    case "accepted":
      el("message").innerText = `${g.first_name}, your name tag is on the way. Please hold.`;
      el("dots").style.display = "none"; declineActive = false;
      break;
    case "declined":
      el("message").innerText = "Please wait one additional minute.";
      el("dots").style.display = "flex"; declineActive = true; dotStep = 0;
      break;
    case "completed":
    case "dismissed":
      resetKiosk();
      break;
  }
}

// Dot sequence
function dotClick(index) {
  if (!declineActive) return;
  const sequence = [1,0,2];
  if (index === sequence[dotStep]) {
    dotStep++;
    if (dotStep === 3) awaitDismiss();
  } else { dotStep = 0; }
}

function awaitDismiss() {
  fetch("/api/update", { method:"POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ guestId, status: "dismissed" }) })
    .then(() => resetKiosk());
}

// Reset kiosk
function resetKiosk() {
  clearInterval(pollTimer); pollTimer = null; guestId = null; scannedData = ""; declineActive = false; dotStep = 0;
  el("first").value = ""; el("last").value = ""; el("waiting").style.display = "none";
  el("form-step-1").style.display = "block"; el("form-step-2").style.display = "none";
  el("dots").style.display = "none"; el("camera-msg").style.background = "rgba(0,0,0,0.7)";
  el("camera-msg").innerText = "Scan your QR code";
  el("first").focus();
  exitFullscreen();
}

// Initialize everything
setupAutoFocus();
handleKeyboard();
</script>
</body>
</html>
