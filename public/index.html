<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>The Eddie's 2025 - Self Checkin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<style>
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'Helvetica Neue', Helvetica, Arial, sans-serif; background:#fff; color:#333; display:flex; flex-direction:column; justify-content:flex-start; align-items:center; height:100vh; width:100%; overflow:hidden; }
#main-container { width:100%; max-width:600px; padding:20px; text-align:center; flex:1; }
h1 { margin-bottom:20px; font-size:32px; text-transform:uppercase; font-weight:800; }
input { font-size:24px; padding:15px; margin-bottom:15px; width:100%; text-align:left; border-radius:8px; border:2px solid #e0e0e0; outline:none; background:#f8f8f8; transition:border 0.2s; }
input.active-input { border-color:#000; }
button { font-size:18px; padding:18px; margin-top:10px; width:100%; background:#000; color:#fff; border:none; border-radius:8px; cursor:pointer; text-transform:uppercase; font-weight:700; letter-spacing:1px; }
#form-step-2, #waiting { display:none; }
#camera-container { width:100%; max-width:300px; height:300px; margin:0 auto 20px; border:4px solid #000; border-radius:12px; overflow:hidden; background:#000; position:relative;}
#video { width:100%; height:100%; object-fit:cover; }
#camera-msg { position:absolute; bottom:10px; left:0; right:0; color:white; background:rgba(0,0,0,0.7); padding:5px; font-size:14px; }
#dots { display:none; justify-content:center; gap:15px; margin-top:30px; }
#dots button { width:50px; height:50px; font-size:12px; border-radius:50%; background:#f0f0f0; color:#ccc; display:flex; align-items:center; justify-content:center; margin:0; }
#custom-keyboard { display:flex; flex-direction:column; position:fixed; bottom:0; left:0; right:0; background:#000; padding:5px; gap:5px; z-index:1000; }
.keyboard-row { display:flex; justify-content:center; gap:5px; }
.keyboard-row button { flex:1; font-size:22px; padding:15px 0; border-radius:12px; border:2px solid #000; background:#111; color:#fff; font-weight:700; cursor:pointer; user-select:none; transition:transform 0.1s, background 0.2s; }
.keyboard-row button:active { transform:scale(0.95); background:#333; }
</style>
</head>
<body>
<div id="main-container">
  <h1>The Eddie's 2025 - Self Checkin</h1>

  <div id="form-step-1">
    <input id="first" placeholder="First Name" autocomplete="off" />
    <input id="last" placeholder="Last Name" autocomplete="off" />
    <button id="next-btn">Next</button>
    <div id="custom-keyboard"></div>
  </div>

  <div id="form-step-2">
    <div id="camera-container">
      <video id="video" playsinline></video>
      <div id="camera-msg">Scan your QR code</div>
    </div>
  </div>

  <div id="waiting">
    <h2 id="message">Please wait...</h2>
    <div id="dots">
      <button onclick="dotClick(0)">●</button>
      <button onclick="dotClick(1)">●</button>
      <button onclick="dotClick(2)">●</button>
    </div>
  </div>
</div>

<script>
let guestId=null, pollTimer=null, dotStep=0, declineActive=false, scannedData="", typingTimer=null, nextPressTimer=null;
const firstInput=document.getElementById("first"), lastInput=document.getElementById("last"), nextBtn=document.getElementById("next-btn");
const keyboard=document.getElementById("custom-keyboard");

// Keyboard rows layout (QWERTY, lowercase)
const keyboardRows = [
  ["q","w","e","r","t","y","u","i","o","p"],
  ["a","s","d","f","g","h","j","k","l"],
  ["z","x","c","v","b","n","m"," "]
];

function showKeyboard(inputEl){
  keyboard.innerHTML="";
  [firstInput,lastInput].forEach(i=>i.classList.remove("active-input"));
  inputEl.classList.add("active-input");
  keyboardRows.forEach(row=>{
    const div=document.createElement("div");
    div.className="keyboard-row";
    row.forEach(key=>{
      const btn=document.createElement("button");
      btn.textContent=key===" "?"␣":key;
      btn.onclick=()=>{
        if(key===" ") inputEl.value+=" ";
        else inputEl.value+=key;
        resetTypingTimer(inputEl);
      };
      div.appendChild(btn);
    });
    keyboard.appendChild(div);
  });
  keyboard.style.display="flex";
}

// Auto-switch after 3s inactivity
function resetTypingTimer(inputEl){
  clearTimeout(typingTimer);
  typingTimer=setTimeout(()=>{
    if(inputEl===firstInput){ lastInput.focus(); showKeyboard(lastInput); }
    else if(inputEl===lastInput){ nextBtn.click(); }
  },3000);
}

// Highlight active input
[firstInput,lastInput].forEach(inp=>{
  inp.addEventListener("focus",()=>showKeyboard(inp));
});

// Long press Next for fullscreen
nextBtn.addEventListener("mousedown", ()=>{ nextPressTimer=setTimeout(()=>enterFullscreen(),1000); });
nextBtn.addEventListener("mouseup", ()=>clearTimeout(nextPressTimer));
nextBtn.addEventListener("mouseleave", ()=>clearTimeout(nextPressTimer));
nextBtn.addEventListener("click", goToScan);

// Fullscreen functions
function enterFullscreen(){ const elBody=document.documentElement; if(elBody.requestFullscreen) elBody.requestFullscreen(); else if(elBody.webkitRequestFullscreen) elBody.webkitRequestFullscreen(); else if(elBody.msRequestFullscreen) elBody.msRequestFullscreen();}
function exitFullscreen(){ if(document.fullscreenElement) document.exitFullscreen(); else if(document.webkitFullscreenElement) document.webkitExitFullscreen(); else if(document.msFullscreenElement) document.msExitFullscreen(); }

// Focus first input on load
window.onload = ()=>{ firstInput.focus(); showKeyboard(firstInput); };

// Helper
function el(id){ return document.getElementById(id); }

// --- QR Scan ---
function goToScan(){
  if(!firstInput.value.trim() || !lastInput.value.trim()) return alert("Please enter both names");
  el("form-step-1").style.display="none"; el("form-step-2").style.display="block";
  keyboard.style.display="none";
  startScanner();
}

function startScanner(){
  const video=el("video"), cameraMsg=el("camera-msg");
  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
    .then(stream=>{ video.srcObject=stream; video.play(); requestAnimationFrame(tick); })
    .catch(err=>{ cameraMsg.innerText="Camera access denied."; console.error(err); });
  function tick(){
    if(video.readyState===video.HAVE_ENOUGH_DATA){
      const canvas=document.createElement("canvas").getContext("2d");
      canvas.canvas.width=video.videoWidth; canvas.canvas.height=video.videoHeight;
      canvas.drawImage(video,0,0,canvas.canvas.width,canvas.canvas.height);
      const imageData=canvas.getImageData(0,0,canvas.canvas.width,canvas.canvas.height);
      const code=jsQR(imageData.data,imageData.width,imageData.height);
      if(code){ scannedData=code.data; cameraMsg.innerText="QR Scanned!"; cameraMsg.style.background="green"; video.srcObject.getTracks().forEach(t=>t.stop()); submitCheckin(); return; }
    }
    requestAnimationFrame(tick);
  }
}

// --- Submit ---
async function submitCheckin(){
  const res=await fetch("/api/checkin",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({firstName:firstInput.value,lastName:lastInput.value,qrData:scannedData})});
  const data=await res.json(); guestId=data.guestId;
  el("form-step-2").style.display="none"; el("waiting").style.display="block";
  el("message").innerText="Thank you. Please wait a minute while we analyze your information.";
  dotStep=0; el("dots").style.display="none"; declineActive=false;
  pollTimer=setInterval(pollStatus,2000);
}

// --- Poll ---
async function pollStatus(){
  if(!guestId) return;
  const res=await fetch(`/api/guest/${guestId}`); const g=await res.json();
  switch(g.status){
    case "accepted": el("message").innerText=`${g.first_name}, your name tag is on the way.`; el("dots").style.display="none"; declineActive=false; break;
    case "declined": el("message").innerText="Please wait one additional minute."; el("dots").style.display="flex"; declineActive=true; dotStep=0; break;
    case "completed": case "dismissed": resetKiosk(); break;
  }
}

// --- Dot click ---
function dotClick(index){ if(!declineActive) return; const sequence=[1,0,2]; if(index===sequence[dotStep]){dotStep++; if(dotStep===3) awaitDismiss();} else dotStep=0; }
function awaitDismiss(){ fetch("/api/update",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({guestId,status:"dismissed"})}).then(()=>resetKiosk()); }

// --- Reset kiosk ---
function resetKiosk(){
  clearInterval(pollTimer); pollTimer=null; guestId=null; scannedData=""; declineActive=false; dotStep=0;
  firstInput.value=""; lastInput.value=""; el("waiting").style.display="none";
  el("form-step-1").style.display="block"; el("form-step-2").style.display="none";
  el("dots").style.display="none"; el("camera-msg").style.background="rgba(0,0,0,0.7)"; el("camera-msg").innerText="Scan your QR code";
  firstInput.focus(); showKeyboard(firstInput);
  exitFullscreen();
}
</script>
</body>
</html>
